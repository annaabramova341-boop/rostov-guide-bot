const express = require('express');
const fs = require('fs');
const path = require('path');
const app = express();
app.use(express.json());

const DATA_FILE = path.join(__dirname, 'userData.json');

function loadUserData() {
  try {
    if (fs.existsSync(DATA_FILE)) {
      const data = fs.readFileSync(DATA_FILE, 'utf8');
      return JSON.parse(data);
    }
  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…:', error);
  }
  return {};
}

function saveUserData(data) {
  try {
    fs.writeFileSync(DATA_FILE, JSON.stringify(data, null, 2), 'utf8');
  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…:', error);
  }
}

let userData = loadUserData();

const placesDatabase = {
  'Ð”Ð¾Ð¼ Ð°ÐºÑ‚Ñ€Ð¸ÑÑ‹ ÐœÐ°Ñ€Ð³Ð°Ñ€Ð¸Ñ‚Ñ‹ Ð§ÐµÑ€Ð½Ð¾Ð²Ð¾Ð¹': { category: 'ÐžÑÐ¾Ð±Ð½ÑÐºÐ¸', type: 'Ð˜ÑÑ‚Ð¾Ñ€Ð¸ÐºÐ¾-Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'Ð”Ð¾Ð¼ Ð±Ñ€Ð°Ñ‚ÑŒÐµÐ² ÐœÐ°Ñ€Ñ‚Ñ‹Ð½': { category: 'ÐžÑÐ¾Ð±Ð½ÑÐºÐ¸', type: 'Ð˜ÑÑ‚Ð¾Ñ€Ð¸ÐºÐ¾-Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'Ð”Ð¾Ñ…Ð¾Ð´Ð½Ñ‹Ð¹ Ð´Ð¾Ð¼ ÐŸ.Ð .ÐœÐ°ÐºÑÐ¸Ð¼Ð¾Ð²Ð°': { category: 'ÐžÑÐ¾Ð±Ð½ÑÐºÐ¸', type: 'Ð˜ÑÑ‚Ð¾Ñ€Ð¸ÐºÐ¾-Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'ÐžÑÐ¾Ð±Ð½ÑÐº ÐŸÐ°Ñ€Ð°Ð¼Ð¾Ð½Ð¾Ð²Ð°': { category: 'ÐžÑÐ¾Ð±Ð½ÑÐºÐ¸', type: 'Ð˜ÑÑ‚Ð¾Ñ€Ð¸ÐºÐ¾-Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'Ð›Ð¸Ð²ÐµÐ½Ñ†Ð¾Ð²ÑÐºÐ°Ñ ÐºÑ€ÐµÐ¿Ð¾ÑÑ‚ÑŒ': { category: 'Ð”Ñ€ÐµÐ²Ð½ÑÑ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð°', type: 'Ð˜ÑÑ‚Ð¾Ñ€Ð¸ÐºÐ¾-Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'ÐšÐ°Ñ„ÐµÐ´Ñ€Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐ¾Ð±Ð¾Ñ€': { category: 'Ð”Ñ€ÐµÐ²Ð½ÑÑ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð°', type: 'Ð˜ÑÑ‚Ð¾Ñ€Ð¸ÐºÐ¾-Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'Ð¦ÐµÑ€ÐºÐ¾Ð²ÑŒ Ð¡ÑƒÑ€Ð±-Ð¥Ð°Ñ‡': { category: 'Ð”Ñ€ÐµÐ²Ð½ÑÑ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð°', type: 'Ð˜ÑÑ‚Ð¾Ñ€Ð¸ÐºÐ¾-Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'Ð¢Ð°Ð±Ð°Ñ‡Ð½Ð°Ñ Ñ„Ð°Ð±Ñ€Ð¸ÐºÐ° ÐÑÐ¼Ð¾Ð»Ð¾Ð²Ð°': { category: 'ÐŸÑ€Ð¾Ð¼Ñ‹ÑˆÐ»ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ', type: 'Ð˜ÑÑ‚Ð¾Ñ€Ð¸ÐºÐ¾-Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'ÐŸÐ°Ñ€Ð°Ð¼Ð¾Ð½Ð¾Ð²ÑÐºÐ¸Ðµ ÑÐºÐ»Ð°Ð´Ñ‹': { category: 'ÐŸÑ€Ð¾Ð¼Ñ‹ÑˆÐ»ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ', type: 'Ð˜ÑÑ‚Ð¾Ñ€Ð¸ÐºÐ¾-Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'Ð—Ð°Ð²Ð¾Ð´ Ð Ð¾ÑÑ‚ÐµÐ»ÑŒÐ¼Ð°Ñˆ': { category: 'ÐŸÑ€Ð¾Ð¼Ñ‹ÑˆÐ»ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ', type: 'Ð˜ÑÑ‚Ð¾Ñ€Ð¸ÐºÐ¾-Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'Ð—Ð°Ð²Ð¾Ð´ ÐºÑƒÐ¿Ñ†Ð° ÐŸÐ°Ð½Ð¸Ð½Ð°': { category: 'ÐŸÑ€Ð¾Ð¼Ñ‹ÑˆÐ»ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ', type: 'Ð˜ÑÑ‚Ð¾Ñ€Ð¸ÐºÐ¾-Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'Ð¦ÐµÐ½Ñ‚Ñ€ ÑÐ¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¹ ÐºÑƒÐ»ÑŒÑ‚ÑƒÑ€Ñ‹ Â«Ð¡Ñ‚ÐµÐ»ÑŒÂ»': { category: 'Ð¡Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ðµ Ð¸ÑÐºÑƒÑÑÑ‚Ð²Ð¾', type: 'ÐšÑƒÐ»ÑŒÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'ÐÑ€Ñ‚-Ð¿Ñ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÑÑ‚Ð²Ð¾ Â«Ð“Ð°Ð»ÐµÑ€ÐµÑ NNNÂ»': { category: 'Ð¡Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ðµ Ð¸ÑÐºÑƒÑÑÑ‚Ð²Ð¾', type: 'ÐšÑƒÐ»ÑŒÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'Ð“Ð°Ð»ÐµÑ€ÐµÑ ÑÐ¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¸ÑÐºÑƒÑÑÑ‚Ð²Ð° Â«CultureÂ»': { category: 'Ð¡Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ðµ Ð¸ÑÐºÑƒÑÑÑ‚Ð²Ð¾', type: 'ÐšÑƒÐ»ÑŒÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'ÐÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾Ð±ÑÐµÑ€Ð²Ð°Ñ‚Ð¾Ñ€Ð¸Ñ': { category: 'Ð¡Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ðµ Ð¸ÑÐºÑƒÑÑÑ‚Ð²Ð¾', type: 'ÐšÑƒÐ»ÑŒÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'Ð Ð¾ÑÑ‚Ð¾Ð²ÑÐºÐ¸Ð¹ Ð¾Ð±Ð»Ð°ÑÑ‚Ð½Ð¾Ð¹ Ð¼ÑƒÐ·ÐµÐ¹ ÐºÑ€Ð°ÐµÐ²ÐµÐ´ÐµÐ½Ð¸Ñ': { category: 'ÐœÑƒÐ·ÐµÐ¸', type: 'ÐšÑƒÐ»ÑŒÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'Ð Ð¾ÑÑ‚Ð¾Ð²ÑÐºÐ¸Ð¹ Ð¾Ð±Ð»Ð°ÑÑ‚Ð½Ð¾Ð¹ Ð¼ÑƒÐ·ÐµÐ¹ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð·Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð¸ÑÐºÑƒÑÑÑ‚Ð²': { category: 'ÐœÑƒÐ·ÐµÐ¸', type: 'ÐšÑƒÐ»ÑŒÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'Ð“Ð¾ÑÑƒÐ´Ð°Ñ€ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹ Ð¼ÑƒÐ·ÐµÐ¹-Ð·Ð°Ð¿Ð¾Ð²ÐµÐ´Ð½Ð¸Ðº Ðœ.Ð.Ð¨Ð¾Ð»Ð¾Ñ…Ð¾Ð²Ð° Ð¢Ð¸Ñ…Ð¸Ð¹ Ð”Ð¾Ð½': { category: 'ÐœÑƒÐ·ÐµÐ¸', type: 'ÐšÑƒÐ»ÑŒÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'ÐœÑƒÐ·ÐµÐ¹ ÑÐ¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð·Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾ Ð¸ÑÐºÑƒÑÑÑ‚Ð²Ð°': { category: 'ÐœÑƒÐ·ÐµÐ¸', type: 'ÐšÑƒÐ»ÑŒÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'ÐœÑƒÐ·ÐµÐ¹ Ñ€ÑƒÑÑÐºÐ¾-Ð°Ñ€Ð¼ÑÐ½ÑÐºÐ¾Ð¹ Ð´Ñ€ÑƒÐ¶Ð±Ñ‹': { category: 'ÐœÑƒÐ·ÐµÐ¸', type: 'ÐšÑƒÐ»ÑŒÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'ÐœÑƒÐ·ÐµÐ¹ Ð Ð¾ÑÑ‚Ð¾Ð²ÑÐºÐ¾Ð³Ð¾ Ð³Ð¾ÑÑƒÐ´Ð°Ñ€ÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¼ÑƒÐ·Ñ‹ÐºÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ñ‚ÐµÐ°Ñ‚Ñ€Ð°': { category: 'ÐœÑƒÐ·ÐµÐ¸', type: 'ÐšÑƒÐ»ÑŒÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'Ð•ÑÑ‚ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð½Ð°ÑƒÑ‡Ð½Ñ‹Ð¹ Ð¼ÑƒÐ·ÐµÐ¹ Ð®Ð¶Ð½Ð¾Ð³Ð¾ Ñ„ÐµÐ´ÐµÑ€Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑƒÐ½Ð¸Ð²ÐµÑ€ÑÐ¸Ñ‚ÐµÑ‚Ð°': { category: 'ÐœÑƒÐ·ÐµÐ¸', type: 'ÐšÑƒÐ»ÑŒÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'ÐšÑƒÐ»ÑŒÑ‚ÑƒÑ€Ð½Ð¾-Ð²Ñ‹ÑÑ‚Ð°Ð²Ð¾Ñ‡Ð½Ñ‹Ð¹ Ñ†ÐµÐ½Ñ‚Ñ€ Ð”Ð“Ð¢Ð£ Ð”Ð¾Ð½ÑÐºÐ°Ñ ÐºÐ°Ð·Ð°Ñ‡ÑŒÑ Ð³Ð²Ð°Ñ€Ð´Ð¸Ñ': { category: 'ÐœÑƒÐ·ÐµÐ¸', type: 'ÐšÑƒÐ»ÑŒÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'Ð¨Ð¾Ð»Ð¾Ñ…Ð¾Ð²-Ð¦ÐµÐ½Ñ‚Ñ€': { category: 'ÐœÑƒÐ·ÐµÐ¸', type: 'ÐšÑƒÐ»ÑŒÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'Ð’Ñ‹ÑÑ‚Ð°Ð²Ð¾Ñ‡Ð½Ñ‹Ð¹ Ð·Ð°Ð» Ð ÐžÐž Ð’Ð¢ÐžÐž Ð¡Ð¾ÑŽÐ· Ð¥ÑƒÐ´Ð¾Ð¶Ð½Ð¸ÐºÐ¾Ð² Ð Ð¾ÑÑÐ¸Ð¸': { category: 'ÐœÑƒÐ·ÐµÐ¸', type: 'ÐšÑƒÐ»ÑŒÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'Ð”Ð¾Ð½ÑÐºÐ°Ñ Ð³Ð¾ÑÑƒÐ´Ð°Ñ€ÑÑ‚Ð²ÐµÐ½Ð½Ð°Ñ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ð°Ñ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ°': { category: 'Ð¢ÐµÐ°Ñ‚Ñ€Ñ‹', type: 'ÐšÑƒÐ»ÑŒÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'Ð Ð¾ÑÑ‚Ð¾Ð²ÑÐºÐ¸Ð¹ Ð°ÐºÐ°Ð´ÐµÐ¼Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ñ‚ÐµÐ°Ñ‚Ñ€ Ð´Ñ€Ð°Ð¼Ñ‹ Ð¸Ð¼. Ðœ. Ð“Ð¾Ñ€ÑŒÐºÐ¾Ð³Ð¾': { category: 'Ð¢ÐµÐ°Ñ‚Ñ€Ñ‹', type: 'ÐšÑƒÐ»ÑŒÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'Ð Ð¾ÑÑ‚Ð¾Ð²ÑÐºÐ°Ñ Ð³Ð¾ÑÑƒÐ´Ð°Ñ€ÑÑ‚Ð²ÐµÐ½Ð½Ð°Ñ Ñ„Ð¸Ð»Ð°Ñ€Ð¼Ð¾Ð½Ð¸Ñ': { category: 'Ð¢ÐµÐ°Ñ‚Ñ€Ñ‹', type: 'ÐšÑƒÐ»ÑŒÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'Ð Ð¾ÑÑ‚Ð¾Ð²ÑÐºÐ¸Ð¹ Ð³Ð¾ÑÑƒÐ´Ð°Ñ€ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹ Ð¼ÑƒÐ·Ñ‹ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ‚ÐµÐ°Ñ‚Ñ€': { category: 'Ð¢ÐµÐ°Ñ‚Ñ€Ñ‹', type: 'ÐšÑƒÐ»ÑŒÑ‚ÑƒÑ€Ð½Ñ‹Ðµ' },
  'Ð ÐµÑÑ‚Ð¾Ñ€Ð°Ð½ ÐÑ‚Ð°Ð¼Ð°Ð½ÑÐºÐ°Ñ ÑƒÑÐ°Ð´ÑŒÐ±Ð°': { category: 'Ð ÑƒÑÑÐºÐ°Ñ ÐºÑƒÑ…Ð½Ñ', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'ÐšÐ°Ñ„Ðµ-ÐºÑƒÐ»Ð¸Ð½Ð°Ñ€Ð¸Ñ Ð”Ð¾Ð½ÑÐºÐ°Ñ ÑÑ‚Ð°Ð½Ð¸Ñ†Ð°': { category: 'Ð ÑƒÑÑÐºÐ°Ñ ÐºÑƒÑ…Ð½Ñ', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'ÐšÐ°Ñ„Ðµ Ð Ð¾ÑÑ‚Ð¾Ð²': { category: 'Ð ÑƒÑÑÐºÐ°Ñ ÐºÑƒÑ…Ð½Ñ', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'ÐšÐ°Ð·Ð°Ñ‡Ð¸Ð¹ ÐºÑƒÑ€ÐµÐ½ÑŒ': { category: 'Ð ÑƒÑÑÐºÐ°Ñ ÐºÑƒÑ…Ð½Ñ', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'Ð ÐµÑÑ‚Ð¾Ñ€Ð°Ð½ ÐžÐ½ÐµÐ³Ð¸Ð½ Ð”Ð°Ñ‡Ð°': { category: 'Ð ÑƒÑÑÐºÐ°Ñ ÐºÑƒÑ…Ð½Ñ', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'ÐŸÐ°Ñ€Ðº-Ð¾Ñ‚ÐµÐ»ÑŒ Ð”Ð¾Ð½ÑÐºÐ°Ñ Ñ€Ð¾Ñ‰Ð°': { category: 'Ð ÑƒÑÑÐºÐ°Ñ ÐºÑƒÑ…Ð½Ñ', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'Ð¢Ð­Ð¥Ðž': { category: 'ÐÐ·Ð¸Ð°Ñ‚ÑÐºÐ°Ñ ÐºÑƒÑ…Ð½Ñ', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'Ð¢Ð°Ð¹ Ð¿Ð¾': { category: 'ÐÐ·Ð¸Ð°Ñ‚ÑÐºÐ°Ñ ÐºÑƒÑ…Ð½Ñ', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'ÐœÐ°ÐºÐ°Ð¾': { category: 'ÐÐ·Ð¸Ð°Ñ‚ÑÐºÐ°Ñ ÐºÑƒÑ…Ð½Ñ', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'Umami': { category: 'ÐÐ·Ð¸Ð°Ñ‚ÑÐºÐ°Ñ ÐºÑƒÑ…Ð½Ñ', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'Mr. Pho': { category: 'ÐÐ·Ð¸Ð°Ñ‚ÑÐºÐ°Ñ ÐºÑƒÑ…Ð½Ñ', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'Ð¡Ð¸Ð»Ð»Ð°': { category: 'ÐÐ·Ð¸Ð°Ñ‚ÑÐºÐ°Ñ ÐºÑƒÑ…Ð½Ñ', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'Kuksu Ramen': { category: 'ÐÐ·Ð¸Ð°Ñ‚ÑÐºÐ°Ñ ÐºÑƒÑ…Ð½Ñ', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'Ð ÐµÑÑ‚Ð¾Ñ€Ð°Ð½ Fu Dog China': { category: 'ÐÐ·Ð¸Ð°Ñ‚ÑÐºÐ°Ñ ÐºÑƒÑ…Ð½Ñ', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'COFFEELAB': { category: 'ÐšÐ¾Ñ„ÐµÐ¹Ð½Ð¸', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'Balance coffee': { category: 'ÐšÐ¾Ñ„ÐµÐ¹Ð½Ð¸', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'Black fox coffee': { category: 'ÐšÐ¾Ñ„ÐµÐ¹Ð½Ð¸', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'Coffeeman': { category: 'ÐšÐ¾Ñ„ÐµÐ¹Ð½Ð¸', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'Sample coffee': { category: 'ÐšÐ¾Ñ„ÐµÐ¹Ð½Ð¸', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  "Setter's": { category: 'ÐšÐ¾Ñ„ÐµÐ¹Ð½Ð¸', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'Yankee siera': { category: 'ÐšÐ¾Ñ„ÐµÐ¹Ð½Ð¸', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'ÐÐ¾Ð²Ð°Ñ ÐºÐ¾Ñ„ÐµÐ¹Ð½Ñ ANY': { category: 'ÐšÐ¾Ñ„ÐµÐ¹Ð½Ð¸', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'Ð‘Ð¸ÑÑ‚Ñ€Ð¾ Chicko': { category: 'ÐšÐ¾Ñ„ÐµÐ¹Ð½Ð¸', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'ÐžÐ±Ñ‰ÐµÑÑ‚Ð²Ð¾ ÑÑ‹Ð½Ñ‹Ñ…': { category: 'ÐšÐ¾Ñ„ÐµÐ¹Ð½Ð¸', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'StandUp Bar RND': { category: 'ÐšÐ¾Ñ„ÐµÐ¹Ð½Ð¸', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'Ð¡Ð°Ð¿Ð¾Ñ€Ðµ Ð˜Ñ‚Ð°Ð»ÑŒÑÐ½Ð¾': { category: 'Ð•Ð²Ñ€Ð¾Ð¿ÐµÐ¹ÑÐºÐ°Ñ ÐºÑƒÑ…Ð½Ñ', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'Ð¡Ð°Ð½ Ñ‚Ñ€Ð¾Ð¿Ðµ': { category: 'Ð•Ð²Ñ€Ð¾Ð¿ÐµÐ¹ÑÐºÐ°Ñ ÐºÑƒÑ…Ð½Ñ', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'Grill garden': { category: 'Ð•Ð²Ñ€Ð¾Ð¿ÐµÐ¹ÑÐºÐ°Ñ ÐºÑƒÑ…Ð½Ñ', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'Ð“Ð»ÑƒÐ¿Ñ‹Ð¹ Ñ„Ñ€Ð°Ð½Ñ†ÑƒÐ·': { category: 'Ð•Ð²Ñ€Ð¾Ð¿ÐµÐ¹ÑÐºÐ°Ñ ÐºÑƒÑ…Ð½Ñ', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'SanRemo Ð ÐµÑÑ‚Ð¾Ñ€Ð°Ð½&ÐšÐ°Ñ€Ð°Ð¾ÐºÐµ': { category: 'Ð•Ð²Ñ€Ð¾Ð¿ÐµÐ¹ÑÐºÐ°Ñ ÐºÑƒÑ…Ð½Ñ', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'Ð›ÐµÐ²Ð°Ð½Ñ‚Ðµ': { category: 'Ð•Ð²Ñ€Ð¾Ð¿ÐµÐ¹ÑÐºÐ°Ñ ÐºÑƒÑ…Ð½Ñ', type: 'Ð“Ð°ÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ' },
  'Ð›ÐµÐ²Ð¾Ð±ÐµÑ€ÐµÐ¶Ð½Ñ‹Ð¹ Ð¿Ð°Ñ€Ðº': { category: 'ÐŸÐ°Ñ€ÐºÐ¸', type: 'ÐŸÐ°Ñ€ÐºÐ¸ Ð¸ Ð¾Ñ‚Ð´Ñ‹Ñ…' },
  'Ð­Ñ‚Ð½Ð¾-ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ Â«ÐšÑƒÐ¼Ð¶Ð°Â»': { category: 'ÐŸÐ°Ñ€ÐºÐ¸', type: 'ÐŸÐ°Ñ€ÐºÐ¸ Ð¸ Ð¾Ñ‚Ð´Ñ‹Ñ…' },
  'Ð Ð¾ÑÑ‚Ð¾Ð²ÑÐºÐ¸Ð¹-Ð½Ð°-Ð”Ð¾Ð½Ñƒ Ð—Ð¾Ð¾Ð¿Ð°Ñ€Ðº': { category: 'ÐŸÐ°Ñ€ÐºÐ¸', type: 'ÐŸÐ°Ñ€ÐºÐ¸ Ð¸ Ð¾Ñ‚Ð´Ñ‹Ñ…' },
  'Ð¢Ñ€Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð·Ð¾Ð¾Ð¿Ð°Ñ€Ðº': { category: 'ÐŸÐ°Ñ€ÐºÐ¸', type: 'ÐŸÐ°Ñ€ÐºÐ¸ Ð¸ Ð¾Ñ‚Ð´Ñ‹Ñ…' },
  'Ð¦ÐµÐ½Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð°Ñ€Ðº Ð¸Ð¼. Ðœ. Ð“Ð¾Ñ€ÑŒÐºÐ¾Ð³Ð¾': { category: 'ÐŸÐ°Ñ€ÐºÐ¸', type: 'ÐŸÐ°Ñ€ÐºÐ¸ Ð¸ Ð¾Ñ‚Ð´Ñ‹Ñ…' },
  'ÐŸÐ°Ñ€Ðº Ð¸Ð¼. ÐÐ¸ÐºÐ¾Ð»Ð°Ñ ÐžÑÑ‚Ñ€Ð¾Ð²ÑÐºÐ¾Ð³Ð¾': { category: 'ÐŸÐ°Ñ€ÐºÐ¸', type: 'ÐŸÐ°Ñ€ÐºÐ¸ Ð¸ Ð¾Ñ‚Ð´Ñ‹Ñ…' },
  'ÐŸÐ°Ñ€Ðº Ð¸Ð¼. ÐžÐºÑ‚ÑÐ±Ñ€ÑŒÑÐºÐ¾Ð¹ Ñ€ÐµÐ²Ð¾Ð»ÑŽÑ†Ð¸Ð¸': { category: 'ÐŸÐ°Ñ€ÐºÐ¸', type: 'ÐŸÐ°Ñ€ÐºÐ¸ Ð¸ Ð¾Ñ‚Ð´Ñ‹Ñ…' },
  'ÐŸÐ°Ñ€Ðº Ð¸Ð¼. 1 Ð¼Ð°Ñ': { category: 'ÐŸÐ°Ñ€ÐºÐ¸', type: 'ÐŸÐ°Ñ€ÐºÐ¸ Ð¸ Ð¾Ñ‚Ð´Ñ‹Ñ…' },
  'Ð‘Ð¾Ñ‚Ð°Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ ÑÐ°Ð´ Ð®Ñ„Ð£': { category: 'ÐŸÐ°Ñ€ÐºÐ¸', type: 'ÐŸÐ°Ñ€ÐºÐ¸ Ð¸ Ð¾Ñ‚Ð´Ñ‹Ñ…' },
  'ÐÐ°Ð±ÐµÑ€ÐµÐ¶Ð½Ð°Ñ Ñ€ÐµÐºÐ¸ Ð”Ð¾Ð½': { category: 'ÐŸÐ°Ñ€ÐºÐ¸', type: 'ÐŸÐ°Ñ€ÐºÐ¸ Ð¸ Ð¾Ñ‚Ð´Ñ‹Ñ…' },
  'Ð›Ð°Ð·ÐµÑ€Ñ‚Ð°Ð³ Ð¢Ð ÐžÐ': { category: 'ÐÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ð¾Ñ‚Ð´Ñ‹Ñ…', type: 'ÐŸÐ°Ñ€ÐºÐ¸ Ð¸ Ð¾Ñ‚Ð´Ñ‹Ñ…' },
  'ÐŸÐµÐ¹Ð½Ñ‚Ð±Ð¾Ð» Paint Shot': { category: 'ÐÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ð¾Ñ‚Ð´Ñ‹Ñ…', type: 'ÐŸÐ°Ñ€ÐºÐ¸ Ð¸ Ð¾Ñ‚Ð´Ñ‹Ñ…' },
  'ÐšÐ»ÑƒÐ± Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð¹ Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Skynet VR': { category: 'ÐÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ð¾Ñ‚Ð´Ñ‹Ñ…', type: 'ÐŸÐ°Ñ€ÐºÐ¸ Ð¸ Ð¾Ñ‚Ð´Ñ‹Ñ…' },
  'ÐŸÑ€ÑÑ‚ÐºÐ¸ Ð² Ñ‚ÐµÐ¼Ð½Ð¾Ñ‚Ðµ "ÐœÐµÑÑ‚Ð¾ ÐŸÑ€ÑÑ‚Ð¾Ðº"': { category: 'ÐÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ð¾Ñ‚Ð´Ñ‹Ñ…', type: 'ÐŸÐ°Ñ€ÐºÐ¸ Ð¸ Ð¾Ñ‚Ð´Ñ‹Ñ…' },
  'Ð¦ÐµÑ€ÐºÐ¾Ð²ÑŒ Ð¡ÑƒÑ€Ð±-Ð¥Ð°Ñ‡ (ÐÑ€Ð¼ÑÐ½ÑÐºÐ°Ñ Ð°Ð¿Ð¾ÑÑ‚Ð¾Ð»ÑŒÑÐºÐ°Ñ Ñ†ÐµÑ€ÐºÐ¾Ð²ÑŒ)': { category: 'Ð¥Ñ€Ð°Ð¼Ñ‹ Ð´Ñ€ÑƒÐ³Ð¸Ñ… ÐºÐ¾Ð½Ñ„ÐµÑÑÐ¸Ð¹', type: 'Ð ÐµÐ»Ð¸Ð³Ð¸Ð¾Ð·Ð½Ñ‹Ðµ' },
  'Ð¥Ð¾Ñ€Ð°Ð»ÑŒÐ½Ð°Ñ ÑÐ¸Ð½Ð°Ð³Ð¾Ð³Ð° (Ð˜ÑƒÐ´Ð°Ð¸Ð·Ð¼)': { category: 'Ð¥Ñ€Ð°Ð¼Ñ‹ Ð´Ñ€ÑƒÐ³Ð¸Ñ… ÐºÐ¾Ð½Ñ„ÐµÑÑÐ¸Ð¹', type: 'Ð ÐµÐ»Ð¸Ð³Ð¸Ð¾Ð·Ð½Ñ‹Ðµ' },
  'Ð¦ÐµÑ€ÐºÐ¾Ð²ÑŒ Ð¢Ð°Ð¹Ð½Ð¾Ð¹ Ð’ÐµÑ‡ÐµÑ€Ð¸ (ÐŸÑ€Ð¾Ñ‚ÐµÑÑ‚Ð°Ð½Ñ‚Ð¸Ð·Ð¼)': { category: 'Ð¥Ñ€Ð°Ð¼Ñ‹ Ð´Ñ€ÑƒÐ³Ð¸Ñ… ÐºÐ¾Ð½Ñ„ÐµÑÑÐ¸Ð¹', type: 'Ð ÐµÐ»Ð¸Ð³Ð¸Ð¾Ð·Ð½Ñ‹Ðµ' },
  'ÐšÐ°Ñ„ÐµÐ´Ñ€Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐ¾Ð±Ð¾Ñ€ Ð Ð¾Ð¶Ð´ÐµÑÑ‚Ð²Ð° ÐŸÑ€ÐµÑÐ²ÑÑ‚Ð¾Ð¹ Ð‘Ð¾Ð³Ð¾Ñ€Ð¾Ð´Ð¸Ñ†Ñ‹': { category: 'ÐŸÑ€Ð°Ð²Ð¾ÑÐ»Ð°Ð²Ð½Ñ‹Ðµ Ñ…Ñ€Ð°Ð¼Ñ‹', type: 'Ð ÐµÐ»Ð¸Ð³Ð¸Ð¾Ð·Ð½Ñ‹Ðµ' },
  'Ð¡Ñ‚Ð°Ñ€Ð¾-ÐŸÐ¾ÐºÑ€Ð¾Ð²ÑÐºÐ¸Ð¹ Ñ…Ñ€Ð°Ð¼': { category: 'ÐŸÑ€Ð°Ð²Ð¾ÑÐ»Ð°Ð²Ð½Ñ‹Ðµ Ñ…Ñ€Ð°Ð¼Ñ‹', type: 'Ð ÐµÐ»Ð¸Ð³Ð¸Ð¾Ð·Ð½Ñ‹Ðµ' },
  'Ð¦ÐµÑ€ÐºÐ¾Ð²ÑŒ ÐÐ»ÐµÐºÑÐ°Ð½Ð´Ñ€Ð° ÐÐµÐ²ÑÐºÐ¾Ð³Ð¾': { category: 'ÐŸÑ€Ð°Ð²Ð¾ÑÐ»Ð°Ð²Ð½Ñ‹Ðµ Ñ…Ñ€Ð°Ð¼Ñ‹', type: 'Ð ÐµÐ»Ð¸Ð³Ð¸Ð¾Ð·Ð½Ñ‹Ðµ' },
  'Ð¡Ð²ÑÑ‚Ð¾-Ð˜Ð²ÐµÑ€ÑÐºÐ¸Ð¹ Ð¶ÐµÐ½ÑÐºÐ¸Ð¹ Ð¼Ð¾Ð½Ð°ÑÑ‚Ñ‹Ñ€ÑŒ': { category: 'ÐŸÑ€Ð°Ð²Ð¾ÑÐ»Ð°Ð²Ð½Ñ‹Ðµ Ñ…Ñ€Ð°Ð¼Ñ‹', type: 'Ð ÐµÐ»Ð¸Ð³Ð¸Ð¾Ð·Ð½Ñ‹Ðµ' },
  'Ð¦ÐµÑ€ÐºÐ¾Ð²ÑŒ Ð¡Ð²ÑÑ‚Ð¾Ð³Ð¾ Ð“ÐµÐ¾Ñ€Ð³Ð¸Ñ ÐŸÐ¾Ð±ÐµÐ´Ð¾Ð½Ð¾ÑÑ†Ð°': { category: 'ÐŸÑ€Ð°Ð²Ð¾ÑÐ»Ð°Ð²Ð½Ñ‹Ðµ Ñ…Ñ€Ð°Ð¼Ñ‹', type: 'Ð ÐµÐ»Ð¸Ð³Ð¸Ð¾Ð·Ð½Ñ‹Ðµ' },
  'Ð¥Ñ€Ð°Ð¼ Ð¡Ð²ÑÑ‚Ð¾Ð¹ Ð¢Ñ€Ð¾Ð¸Ñ†Ñ‹': { category: 'ÐŸÑ€Ð°Ð²Ð¾ÑÐ»Ð°Ð²Ð½Ñ‹Ðµ Ñ…Ñ€Ð°Ð¼Ñ‹', type: 'Ð ÐµÐ»Ð¸Ð³Ð¸Ð¾Ð·Ð½Ñ‹Ðµ' },
  'Ð¦ÐµÑ€ÐºÐ¾Ð²ÑŒ ÐšÐ°Ð·Ð°Ð½ÑÐºÐ¾Ð¹ Ð¸ÐºÐ¾Ð½Ñ‹ Ð‘Ð¾Ð¶Ð¸ÐµÐ¹ ÐœÐ°Ñ‚ÐµÑ€Ð¸': { category: 'ÐŸÑ€Ð°Ð²Ð¾ÑÐ»Ð°Ð²Ð½Ñ‹Ðµ Ñ…Ñ€Ð°Ð¼Ñ‹', type: 'Ð ÐµÐ»Ð¸Ð³Ð¸Ð¾Ð·Ð½Ñ‹Ðµ' },
  'Ð¥Ñ€Ð°Ð¼ Ð¦ÐµÐ»Ð¸Ñ‚ÐµÐ»Ñ ÐŸÐ°Ð½Ñ‚ÐµÐ»ÐµÐ¸Ð¼Ð¾Ð½Ð°': { category: 'ÐŸÑ€Ð°Ð²Ð¾ÑÐ»Ð°Ð²Ð½Ñ‹Ðµ Ñ…Ñ€Ð°Ð¼Ñ‹', type: 'Ð ÐµÐ»Ð¸Ð³Ð¸Ð¾Ð·Ð½Ñ‹Ðµ' },
  'Ð¥Ñ€Ð°Ð¼ Ð¡ÐµÑ€Ð°Ñ„Ð¸Ð¼Ð° Ð¡Ð°Ñ€Ð¾Ð²ÑÐºÐ¾Ð³Ð¾': { category: 'ÐŸÑ€Ð°Ð²Ð¾ÑÐ»Ð°Ð²Ð½Ñ‹Ðµ Ñ…Ñ€Ð°Ð¼Ñ‹', type: 'Ð ÐµÐ»Ð¸Ð³Ð¸Ð¾Ð·Ð½Ñ‹Ðµ' },
  'Ð‘Ð»Ð°Ð³Ð¾Ð²ÐµÑ‰ÐµÐ½ÑÐºÐ¸Ð¹ Ð³Ñ€ÐµÑ‡ÐµÑÐºÐ¸Ð¹ Ñ…Ñ€Ð°Ð¼': { category: 'ÐŸÑ€Ð°Ð²Ð¾ÑÐ»Ð°Ð²Ð½Ñ‹Ðµ Ñ…Ñ€Ð°Ð¼Ñ‹', type: 'Ð ÐµÐ»Ð¸Ð³Ð¸Ð¾Ð·Ð½Ñ‹Ðµ' }
};

app.get('/', (req, res) => {
  res.set('Cache-Control', 'no-cache, no-store, must-revalidate');
  res.send('âœ… Rostov Guide Bot Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚!');
});

app.post('/webhook', (req, res) => {
  try {
    const request = req.body;
    const intentName = request.queryResult?.intent?.displayName || '';
    const userText = request.queryResult?.queryText || '';
    const parameters = request.queryResult?.parameters || {};
    const outputContexts = request.queryResult?.outputContexts || [];
    
    const payload = request.originalDetectIntentRequest?.payload?.data || {};
    const userId = payload.message?.from?.id || payload.from?.id || payload.callback_query?.from?.id;

    console.log('=== WEBHOOK REQUEST ===');
    console.log('Intent:', intentName);
    console.log('User text:', userText);
    console.log('User ID:', userId);

    if (!userId) {
      return res.json({});
    }

    if (!userData[userId]) {
      userData[userId] = { route: [], currentPlace: null };
    }

    const userTextLower = userText.toLowerCase();

    if (intentName === 'clear_route' || 
        intentName === 'ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚' || 
        userTextLower.includes('Ð¾Ñ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚') ||
        userTextLower.includes('Ð¾Ñ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ') ||
        userTextLower.includes('ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚') ||
        userTextLower.includes('ÑÐ±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚')) {
      
      userData[userId].route = [];
      userData[userId].currentPlace = null;
      saveUserData(userData);
      
      return res.json({
        fulfillmentMessages: [{
          text: { 
            text: ['ðŸ—‘ ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚ Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½! Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ ÑÐ±Ð¾Ñ€ÐºÑƒ Ð·Ð°Ð½Ð¾Ð²Ð¾.'] 
          }
        }]
      });
    }

    let detectedPlace = null;
    
    if (parameters.place && placesDatabase[parameters.place]) {
      detectedPlace = parameters.place;
    }
    
    if (!detectedPlace) {
      for (const context of outputContexts) {
        if (context.parameters) {
          const findPlaceInObject = (obj) => {
            for (const key in obj) {
              const value = obj[key];
              if (typeof value === 'string' && placesDatabase[value]) {
                return value;
              } else if (typeof value === 'object' && value !== null) {
                const found = findPlaceInObject(value);
                if (found) return found;
              }
            }
            return null;
          };
          detectedPlace = findPlaceInObject(context.parameters);
          if (detectedPlace) break;
        }
      }
    }
    
    if (!detectedPlace) {
      for (const place of Object.keys(placesDatabase)) {
        if (userTextLower.includes(place.toLowerCase())) {
          detectedPlace = place;
          break;
        }
      }
    }

    if (detectedPlace) {
      userData[userId].currentPlace = detectedPlace;
      saveUserData(userData);
      console.log('ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¾ Ñ‚ÐµÐºÑƒÑ‰ÐµÐµ Ð¼ÐµÑÑ‚Ð¾:', detectedPlace);
    }

    if (intentName === 'add_to_route' || 
        intentName === 'Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð² Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚' || 
        userTextLower.includes('Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð² Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚') ||
        userTextLower.includes('Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ')) {
      
      const placeName = userData[userId].currentPlace;
      
      if (!placeName) {
        return res.json({
          fulfillmentMessages: [{
            text: { 
              text: ['âš ï¸ ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, ÑÐ½Ð°Ñ‡Ð°Ð»Ð° Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¼ÐµÑÑ‚Ð¾ Ð¸Ð· ÑÐ¿Ð¸ÑÐºÐ°!'] 
            }
          }]
        });
      }
      
      if (!userData[userId].route.includes(placeName)) {
        userData[userId].route.push(placeName);
        saveUserData(userData);
        console.log('âœ… ÐœÐµÑÑ‚Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾:', placeName);
        
        return res.json({
          fulfillmentMessages: [{
            text: { 
              text: [`âœ… ÐœÐµÑÑ‚Ð¾ "${placeName}" Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾ Ð² Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚. Ð§Ñ‚Ð¾ Ð´Ð°Ð»ÑŒÑˆÐµ?`] 
            }
          }]
        });
      } else {
        return res.json({
          fulfillmentMessages: [{
            text: {
              text: [`â„¹ï¸ ÐœÐµÑÑ‚Ð¾ "${placeName}" ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ Ð² Ð²Ð°ÑˆÐµÐ¼ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ðµ!`] 
            }
          }]
        });
      }
    }

    if (intentName === 'show_route' || 
        intentName === 'ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚' || 
        intentName === 'ÐœÐ¾Ð¹ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚' ||
        userTextLower.includes('Ð¼Ð¾Ð¹ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚') ||
        userTextLower.includes('Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚')) {
      
      const userRoute = userData[userId].route || [];
      
      if (userRoute.length === 0) {
        return res.json({
          fulfillmentMessages: [{
            text: { 
              text: ['ðŸ—º Ð’Ð°Ñˆ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚ Ð¿ÑƒÑÑ‚. Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð¼ÐµÑÑ‚Ð° Ð¸Ð· ÑÐ¿Ð¸ÑÐºÐ° Ð¸Ð»Ð¸ Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹Ð¹ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚!'] 
            }
          }]
        });
      }
      
      let routeText = 'ðŸŽ‰ Ð’Ð°Ñˆ Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚:\n\n';
      userRoute.forEach((place, index) => {
        const placeInfo = placesDatabase[place] || {};
        routeText += `${index + 1}. ${place}`;
        if (placeInfo.category) routeText += ` (${placeInfo.category})`;
        routeText += '\n';
      });
      
      routeText += `\nðŸ“ Ð’ÑÐµÐ³Ð¾ Ð¼ÐµÑÑ‚: ${userRoute.length}`;
      
      return res.json({
        fulfillmentMessages: [
          {
            text: { 
              text: [routeText] 
            }
          },
          {
            payload: {
              telegram: {
                text: "Ð¥Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð¾Ñ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚?",
                reply_markup: {
                  inline_keyboard: [
                    [{ text: "ðŸ—‘ ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚", callback_data: "ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚" }]
                  ]
                }
              }
            }
          }
        ]
      });
    }

    return res.json({});

  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ°:', error);
    return res.json({
      fulfillmentMessages: [{
        text: { text: ['âš ï¸ ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ðµ Ñ€Ð°Ð·'] }
      }]
    });
  }
});

const PORT = process.env.PORT || 5000;
app.listen(PORT, '0.0.0.0', () => {
  console.log('ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ' + PORT);
});
